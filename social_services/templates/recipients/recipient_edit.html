{% extends 'base.html' %}

{% block title %}{{ recipient.full_name }} - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ{% endblock %}

{% block content %}
<div class="py-6">
    <!-- Header Section -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mx-4 mb-4">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <!-- Title with back button -->
            <div class="flex items-center gap-4">
                <a href="{% url 'recipients:list' %}" class="p-2 hover:bg-slate-100 rounded-lg transition-colors" title="–ö —Å–ø–∏—Å–∫—É">
                    <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                </a>
                <div>
                    <h1 class="text-xl font-semibold text-slate-800">–ü—Ä–æ—Ñ–∏–ª—å –ø—Ä–æ–∂–∏–≤–∞—é—â–µ–≥–æ</h1>
                    <p class="text-sm text-slate-500 mt-1">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–∂–∏–≤–∞—é—â–µ–≥–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="flex flex-wrap items-center gap-3">
                <div class="flex flex-col">
                    <label class="text-xs font-medium text-slate-500 mb-1">–û—Ç–¥–µ–ª–µ–Ω–∏–µ</label>
                    <select id="departmentSelect" onchange="filterRecipients()"
                            class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 min-w-[150px]">
                        <option value="">–í—Å–µ –æ—Ç–¥–µ–ª–µ–Ω–∏—è</option>
                        {% for dept in departments %}
                        {% if dept.department_type in 'residential,mercy,hospital,vacation' %}
                        <option value="{{ dept.id }}" {% if dept.id == recipient.department.id %}selected{% endif %}>
                            {{ dept.name }}
                        </option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
                
                <div class="flex flex-col">
                    <label class="text-xs font-medium text-slate-500 mb-1">–ü—Ä–æ–∂–∏–≤–∞—é—â–∏–π</label>
                    <select id="recipientSelect" onchange="goToRecipient()"
                            class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 min-w-[200px]">
                        {% for r in recipients %}
                        <option value="{{ r.id }}" {% if r.id == recipient.id %}selected{% endif %}>
                            {{ r.full_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Resident Card -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mx-4 mb-4">
        <div class="flex items-start gap-4">
            <!-- –ê–≤–∞—Ç–∞—Ä –ø–æ–ª—É—á–∞—Ç–µ–ª—è -->
            {% if recipient.photo %}
            <div class="w-20 h-20 flex-shrink-0">
                <img src="{{ recipient.photo.url }}" 
                     alt="{{ recipient.full_name }}"
                     class="w-20 h-20 rounded-full object-cover shadow-sm border-2 border-white">
            </div>
            {% else %}
            <div class="w-20 h-20 bg-gradient-to-br from-primary-400 to-primary-600 rounded-full flex items-center justify-center text-white text-2xl font-semibold shadow-sm flex-shrink-0">
                {{ recipient.full_name|slice:":1" }}
            </div>
            {% endif %}
            <div class="flex-1">
                <!-- –§–ò–û —Å –≤–æ–∑—Ä–∞—Å—Ç–æ–º –∏ —Å—Ç–∞—Ç—É—Å–æ–º -->
                <div class="flex items-center gap-2 flex-wrap">
                    <h2 class="text-lg font-semibold text-slate-800">{{ recipient.full_name }}</h2>
                    {% if recipient.age %}
                    <span class="text-slate-500 text-sm">({{ recipient.age }} –ª–µ—Ç)</span>
                    {% endif %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                        {% if recipient.status == 'active' %}bg-green-100 text-green-800
                        {% elif recipient.status == 'vacation' %}bg-yellow-100 text-yellow-800
                        {% elif recipient.status == 'hospital' %}bg-blue-100 text-blue-800
                        {% else %}bg-red-100 text-red-800{% endif %}">
                        {{ recipient.get_status_display }}
                    </span>
                </div>
                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–¥ –§–ò–û –∏ –∫–Ω–æ–ø–∫–∏ —Å–ø—Ä–∞–≤–∞ -->
                <div class="flex items-center justify-between gap-4 mt-1">
                    <div class="flex items-center gap-4 text-sm text-slate-500">
                        <span>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: {{ recipient.birth_date|date:"d.m.Y" }}</span>
                        {% if recipient.department %}
                        <span>–û—Ç–¥–µ–ª–µ–Ω–∏–µ: {{ recipient.department.name }}</span>
                        {% endif %}
                        {% if recipient.room %}
                        <span>–ö–æ–º–Ω–∞—Ç–∞: {{ recipient.room }}</span>
                        {% endif %}
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <a href="{% url 'recipients:contract' recipient.id %}" 
                           class="inline-flex items-center px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm font-medium rounded-lg transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            –ò–ü–ü–°–£
                        </a>
                        <a href="{% url 'reports:act_generator' %}?recipient={{ recipient.id }}" 
                           class="inline-flex items-center px-4 py-2 bg-green-500 hover:bg-green-600 text-white text-sm font-medium rounded-lg transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            –ê–∫—Ç
                        </a>
                        <a href="{% url 'services:tabel' %}?recipient={{ recipient.id }}" 
                           class="inline-flex items-center px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white text-sm font-medium rounded-lg transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/>
                            </svg>
                            –¢–∞–±–µ–ª—å
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left column - Edit Form -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Edit Form Card -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200">
                <div class="px-6 py-4 border-b border-slate-200">
                    <h2 class="text-lg font-semibold text-slate-800">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
                </div>
                
                <form method="post" enctype="multipart/form-data" class="p-6">
                    {% csrf_token %}
                    
                    <!-- Photo Section -->
                    <div class="flex items-start gap-6 mb-6 pb-6 border-b border-slate-100">
                        <div class="flex-shrink-0">
                            {% if recipient.photo %}
                            <img src="{{ recipient.photo.url }}" alt="{{ recipient.full_name }}" 
                                 class="w-24 h-24 rounded-xl object-cover shadow-sm">
                            {% else %}
                            <div class="w-24 h-24 bg-gradient-to-br from-primary-400 to-primary-600 rounded-xl flex items-center justify-center text-white text-3xl font-semibold shadow-sm">
                                {{ recipient.full_name|slice:":1" }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-slate-700 mb-2">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</label>
                            <input type="file" name="photo" accept="image/*"
                                   class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100 cursor-pointer">
                            <p class="mt-1 text-xs text-slate-400">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä: 200x200 –ø–∏–∫—Å–µ–ª–µ–π</p>
                        </div>
                    </div>
                    
                    <!-- Name Fields -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">–§–∞–º–∏–ª–∏—è *</label>
                            <input type="text" name="last_name" value="{{ recipient.last_name }}" required
                                   class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">–ò–º—è *</label>
                            <input type="text" name="first_name" value="{{ recipient.first_name }}" required
                                   class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">–û—Ç—á–µ—Å—Ç–≤–æ</label>
                            <input type="text" name="patronymic" value="{{ recipient.patronymic }}"
                                   class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        </div>
                    </div>
                    
                    <!-- Birth Date -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-2">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è *</label>
                        <input type="date" name="birth_date" value="{{ recipient.birth_date|date:'Y-m-d' }}" required
                               class="w-full md:w-1/3 px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        {% if recipient.age %}
                        <p class="mt-1 text-xs text-slate-500">–í–æ–∑—Ä–∞—Å—Ç: {{ recipient.age }} –ª–µ—Ç</p>
                        {% endif %}
                    </div>
                    
                    <!-- Admission Date -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-2">–î–∞—Ç–∞ –∑–∞—Å–µ–ª–µ–Ω–∏—è</label>
                        <input type="date" name="admission_date" value="{{ recipient.admission_date|date:'Y-m-d' }}"
                               class="w-full md:w-1/3 px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    
                    <!-- Placement Section -->
                    <div class="pt-6 border-t border-slate-100">
                        <h3 class="text-md font-semibold text-slate-800 mb-4">–†–∞–∑–º–µ—â–µ–Ω–∏–µ –∏ —Å—Ç–∞—Ç—É—Å</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">–û—Ç–¥–µ–ª–µ–Ω–∏–µ / –°—Ç–∞—Ç—É—Å *</label>
                                <select name="department" required
                                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                    <optgroup label="–û—Ç–¥–µ–ª–µ–Ω–∏—è –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è">
                                        {% for dept in departments %}
                                            {% if dept.department_type == 'residential' or dept.department_type == 'mercy' %}
                                            <option value="{{ dept.id }}" {% if dept.id == recipient.department.id %}selected{% endif %}>
                                                {{ dept.name }}
                                            </option>
                                            {% endif %}
                                        {% endfor %}
                                    </optgroup>
                                    <optgroup label="–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã">
                                        {% for dept in departments %}
                                            {% if dept.department_type == 'hospital' %}
                                            <option value="{{ dept.id }}" {% if dept.id == recipient.department.id %}selected{% endif %}>
                                                üè• {{ dept.name }}
                                            </option>
                                            {% elif dept.department_type == 'vacation' %}
                                            <option value="{{ dept.id }}" {% if dept.id == recipient.department.id %}selected{% endif %}>
                                                üèñÔ∏è {{ dept.name }}
                                            </option>
                                            {% elif dept.department_type == 'deceased' %}
                                            <option value="{{ dept.id }}" {% if dept.id == recipient.department.id %}selected{% endif %}>
                                                ‚úùÔ∏è {{ dept.name }}
                                            </option>
                                            {% endif %}
                                        {% endfor %}
                                    </optgroup>
                                </select>
                                <p class="mt-1 text-xs text-slate-500">–í—ã–±–æ—Ä –æ—Ç–¥–µ–ª–µ–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–∂–∏–≤–∞—é—â–µ–≥–æ</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">–ö–æ–º–Ω–∞—Ç–∞</label>
                                <input type="number" name="room" value="{{ recipient.room }}" min="1"
                                       class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å</label>
                                <div class="px-4 py-2.5 bg-slate-100 border border-slate-200 rounded-lg text-sm">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                                        {% if recipient.status == 'active' %}bg-green-100 text-green-800
                                        {% elif recipient.status == 'vacation' %}bg-yellow-100 text-yellow-800
                                        {% elif recipient.status == 'hospital' %}bg-blue-100 text-blue-800
                                        {% elif recipient.status == 'deceased' %}bg-red-100 text-red-800
                                        {% else %}bg-slate-100 text-slate-800{% endif %}">
                                        {{ recipient.status_display }}
                                    </span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">–î–∞—Ç–∞ —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞</label>
                                <input type="date" name="discharge_date" value="{{ recipient.discharge_date|date:'Y-m-d' }}"
                                       class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            </div>
                        </div>
                        
                        <!-- Reason for department change -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-slate-700 mb-2">–ü—Ä–∏—á–∏–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–¥–µ–ª–µ–Ω–∏—è/—Å—Ç–∞—Ç—É—Å–∞</label>
                            <input type="text" name="status_reason" placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏—é)"
                                   class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <div class="flex items-center justify-end gap-3 pt-6 border-t border-slate-100">
                        <a href="{% url 'recipients:list' %}" 
                           class="px-4 py-2.5 text-slate-600 hover:text-slate-800 text-sm font-medium transition-colors">
                            –û—Ç–º–µ–Ω–∞
                        </a>
                        <button type="submit" 
                                class="inline-flex items-center px-6 py-2.5 bg-primary-500 hover:bg-primary-600 text-white text-sm font-medium rounded-lg transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Contracts Section -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200">
                <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-slate-800">–ò–ü–ü–°–£ (–î–æ–≥–æ–≤–æ—Ä—ã)</h2>
                    {% if user.is_admin_or_hr %}
                    <a href="/admin/recipients/contract/add/?recipient={{ recipient.id }}" 
                       class="inline-flex items-center px-3 py-1.5 bg-primary-50 hover:bg-primary-100 text-primary-700 text-sm font-medium rounded-lg transition-colors">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        –î–æ–±–∞–≤–∏—Ç—å
                    </a>
                    {% endif %}
                </div>
                
                <div class="divide-y divide-slate-100">
                    {% for contract in contracts %}
                    <div class="p-4 hover:bg-slate-50 transition-colors">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="font-medium text-slate-800">–ò–ü–ü–°–£ ‚Ññ{{ contract.number }}</span>
                                    {% if contract.is_active %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        –î–µ–π—Å—Ç–≤—É–µ—Ç
                                    </span>
                                    {% else %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-600">
                                        –ó–∞–∫—Ä—ã—Ç
                                    </span>
                                    {% endif %}
                                </div>
                                <p class="text-sm text-slate-500 mt-1">
                                    —Å {{ contract.date_start|date:"d.m.Y" }}{% if contract.date_end %} –ø–æ {{ contract.date_end|date:"d.m.Y" }}{% endif %}
                                </p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-slate-500">{{ contract.services.count }} —É—Å–ª—É–≥</span>
                                {% if user.is_admin_or_hr %}
                                <a href="/admin/recipients/contract/{{ contract.id }}/change/" 
                                   class="p-1.5 hover:bg-slate-200 rounded-lg transition-colors">
                                    <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if contract.services.all %}
                        <div class="mt-3 pt-3 border-t border-slate-100">
                            <div class="flex flex-wrap gap-2">
                                {% for cs in contract.services.all %}
                                <span class="inline-flex items-center px-2 py-1 bg-slate-100 text-slate-600 text-xs rounded-md">
                                    {{ cs.service.code }}
                                    {% if cs.max_quantity_per_month %}
                                    <span class="ml-1 text-slate-400">(–º–∞–∫—Å. {{ cs.max_quantity_per_month }}/–º–µ—Å)</span>
                                    {% endif %}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="p-8 text-center">
                        <svg class="w-12 h-12 text-slate-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p class="text-slate-500">–ù–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –ò–ü–ü–°–£</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Right column - Stats -->
        <div class="space-y-6">
            <!-- Status Card -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-sm font-semibold text-slate-800 mb-4">–°—Ç–∞—Ç—É—Å</h3>
                <div class="flex items-center gap-3">
                    <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium
                        {% if recipient.status == 'active' %}bg-green-100 text-green-800
                        {% elif recipient.status == 'vacation' %}bg-yellow-100 text-yellow-800
                        {% elif recipient.status == 'hospital' %}bg-blue-100 text-blue-800
                        {% else %}bg-red-100 text-red-800{% endif %}">
                        {{ recipient.get_status_display }}
                    </span>
                </div>
                
                {% if recipient.discharge_date %}
                <div class="mt-4 pt-4 border-t border-slate-100">
                    <p class="text-xs text-slate-500">–î–∞—Ç–∞ —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞</p>
                    <p class="text-sm font-medium text-slate-800">{{ recipient.discharge_date|date:"d.m.Y" }}</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Statistics Card -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-sm font-semibold text-slate-800 mb-4">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ª—É–≥</h3>
                
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-slate-500">–í—Å–µ–≥–æ –æ–∫–∞–∑–∞–Ω–æ —É—Å–ª—É–≥</span>
                        <span class="text-lg font-semibold text-slate-800">{{ stats.total_services|default:0 }}</span>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-slate-500">–ó–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</span>
                        <span class="text-lg font-semibold text-primary-600">{{ stats.current_month_services|default:0 }}</span>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-slate-500">–û–±—â–∞—è —Å—É–º–º–∞</span>
                        <span class="text-lg font-semibold text-slate-800">{{ stats.total_amount|default:"0"|floatformat:2 }} —Ä—É–±.</span>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-slate-500">–ó–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</span>
                        <span class="text-lg font-semibold text-primary-600">{{ stats.current_month_amount|default:"0"|floatformat:2 }} —Ä—É–±.</span>
                    </div>
                </div>
            </div>
            
            <!-- Recent Services Card -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-sm font-semibold text-slate-800 mb-4">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–∫–∞–∑–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏</h3>
                
                <div class="space-y-3">
                    {% for log in recent_services %}
                    <div class="flex items-center justify-between py-2 border-b border-slate-100 last:border-0">
                        <div>
                            <p class="text-sm font-medium text-slate-800">{{ log.service.name }}</p>
                            <p class="text-xs text-slate-500">{{ log.date|date:"d.m.Y" }}</p>
                        </div>
                        <span class="text-sm text-slate-600">{{ log.quantity }} —à—Ç.</span>
                    </div>
                    {% empty %}
                    <p class="text-sm text-slate-500 text-center py-4">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>
                    {% endfor %}
                </div>
                
                {% if recent_services %}
                <a href="{% url 'services:tabel' %}?recipient={{ recipient.id }}" 
                   class="block mt-4 text-center text-sm text-primary-600 hover:text-primary-700 font-medium">
                    –í—Å–µ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–µ–ª–µ ‚Üí
                </a>
                {% endif %}
            </div>
            
            <!-- Status History Card -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-sm font-semibold text-slate-800 mb-4">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–∞</h3>
                
                <div class="space-y-3">
                    {% for history in status_history %}
                    <div class="flex items-start gap-3 py-2 border-b border-slate-100 last:border-0">
                        <div class="flex-shrink-0 w-2 h-2 mt-2 rounded-full bg-primary-400"></div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                {% if history.old_department %}
                                <span class="text-sm text-slate-600">{{ history.old_department.name }}</span>
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                                </svg>
                                {% endif %}
                                <span class="text-sm font-medium text-slate-800">{{ history.new_department.name }}</span>
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs text-slate-500">{{ history.changed_at|date:"d.m.Y H:i" }}</span>
                                <span class="text-xs text-slate-400">‚Ä¢</span>
                                <span class="text-xs text-slate-500">{{ history.changed_by.get_full_name|default:history.changed_by.username }}</span>
                            </div>
                            {% if history.reason %}
                            <p class="text-xs text-slate-500 mt-1 italic">"{{ history.reason }}"</p>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-sm text-slate-500 text-center py-4">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Placement History Card -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-sm font-semibold text-slate-800 mb-4">–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π</h3>
                
                <div class="space-y-3">
                    {% for history in placement_history %}
                    <div class="flex items-start gap-3 py-2 border-b border-slate-100 last:border-0">
                        <div class="flex-shrink-0 w-2 h-2 mt-2 rounded-full bg-blue-400"></div>
                        <div class="flex-1">
                            <div class="text-sm font-medium text-slate-800 mb-1">{{ history.movement_type }}</div>
                            <div class="flex flex-wrap items-center gap-2 text-xs">
                                {% if history.old_department != history.new_department %}
                                <span class="text-slate-600">{{ history.old_department.name|default:"‚Äî" }}</span>
                                <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                                </svg>
                                <span class="font-medium text-slate-800">{{ history.new_department.name|default:"‚Äî" }}</span>
                                {% endif %}
                                {% if history.old_room != history.new_room %}
                                <span class="text-slate-500">–∫–æ–º. {{ history.old_room|default:"‚Äî" }}</span>
                                <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                                </svg>
                                <span class="font-medium text-slate-800">–∫–æ–º. {{ history.new_room|default:"‚Äî" }}</span>
                                {% endif %}
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs text-slate-500">{{ history.date|date:"d.m.Y" }}</span>
                                {% if history.changed_by %}
                                <span class="text-xs text-slate-400">‚Ä¢</span>
                                <span class="text-xs text-slate-500">{{ history.changed_by.get_full_name|default:history.changed_by.username }}</span>
                                {% endif %}
                            </div>
                            {% if history.reason %}
                            <p class="text-xs text-slate-500 mt-1 italic">"{{ history.reason }}"</p>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-sm text-slate-500 text-center py-4">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>
                    {% endfor %}
                </div>
            </div>
            
            <!-- System Info -->
            <div class="bg-slate-50 rounded-xl p-4">
                <p class="text-xs text-slate-400">–°–æ–∑–¥–∞–Ω–æ: {{ recipient.created_at|date:"d.m.Y H:i" }}</p>
                <p class="text-xs text-slate-400">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ recipient.updated_at|date:"d.m.Y H:i" }}</p>
            </div>
        </div>
    </div>
</div>

<script>
function goToRecipient() {
    const recipientId = document.getElementById('recipientSelect').value;
    if (recipientId) {
        window.location.href = `/recipients/${recipientId}/`;
    }
}

// –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
const recipientsData = [
    {% for r in recipients %}
    {id: {{ r.id }}, name: "{{ r.full_name }}", departmentId: {{ r.department.id|default:0 }}},
    {% endfor %}
];

function filterRecipients() {
    const deptId = document.getElementById('departmentSelect').value;
    const recipientSelect = document.getElementById('recipientSelect');
    const currentRecipientId = {{ recipient.id }};
    
    // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
    recipientSelect.innerHTML = '';
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º
    recipientsData.forEach(r => {
        if (!deptId || r.departmentId == deptId) {
            const option = document.createElement('option');
            option.value = r.id;
            option.textContent = r.name;
            if (r.id == currentRecipientId) {
                option.selected = true;
            }
            recipientSelect.appendChild(option);
        }
    });
}
</script>
{% endblock %}
